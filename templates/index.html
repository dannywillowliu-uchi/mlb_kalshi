<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MLB Arbitrage Trader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Roboto Mono', 'Consolas', 'Monaco', 'Courier New', monospace;
            background: #000000;
            color: #ffffff;
            padding: 5px;
            overflow-x: hidden;
            font-size: 12px;
            line-height: 1.4;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-top: 5px;
        }

        @media (max-width: 1024px) {
            .two-column-layout {
                grid-template-columns: 1fr;
            }
        }

        .header {
            text-align: left;
            padding: 8px 12px;
            background: #0a0a0a;
            border: 1px solid #ffffff;
            border-radius: 0;
            margin-bottom: 5px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .header h1 {
            font-size: 14px;
            margin-bottom: 2px;
            color: #ffffff;
            text-transform: uppercase;
            font-weight: 600;
        }

        .status-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            background: #0a0a0a;
            padding: 6px 8px;
            border: 1px solid #333;
            border-radius: 0;
            margin-bottom: 5px;
            font-size: 11px;
            gap: 15px;
        }

        .status-item {
            text-align: left;
            border-left: 2px solid #333;
            padding-left: 8px;
        }

        .status-item:first-child {
            border-left: none;
            padding-left: 0;
        }

        .status-label {
            color: #666;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .status-value {
            font-size: 13px;
            font-weight: 600;
            margin-top: 2px;
            font-family: 'Roboto Mono', 'Consolas', monospace;
        }

        .status-good { color: #00ff00; }
        .status-warning { color: #ffaa00; }
        .status-bad { color: #ff4444; }

        .setup-section {
            background: #0a0a0a;
            padding: 8px;
            border: 1px solid #333;
            border-radius: 0;
            margin-bottom: 5px;
        }

        .setup-section h3 {
            font-size: 11px;
            margin-bottom: 6px;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 6px 8px;
            font-size: 12px;
            border: 1px solid #333;
            background: #000;
            color: #ffffff;
            border-radius: 0;
            margin-bottom: 5px;
            font-family: 'Roboto Mono', 'Consolas', monospace;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #ffffff;
        }

        button {
            width: 100%;
            padding: 8px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid #333;
            border-radius: 0;
            cursor: pointer;
            transition: all 0.08s;
            touch-action: manipulation;
            font-family: 'Roboto Mono', 'Consolas', monospace;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: #1a1a1a;
            color: #ffffff;
            border-color: #ffffff;
        }

        .btn-primary:hover {
            background: #2a2a2a;
        }

        .btn-success {
            background: #1a1a1a;
            color: #ffffff;
            border-color: #ffffff;
        }

        .btn-danger {
            background: #330000;
            color: #ff4444;
            border-color: #ff4444;
        }

        .btn-buy-yes {
            background: #003300;
            color: #00ff00;
            border: 2px solid #00ff00;
            font-size: 14px;
            padding: 12px;
            margin-bottom: 3px;
            font-weight: 700;
        }

        .btn-buy-yes:hover {
            background: #004400;
        }

        .btn-buy-no {
            background: #330000;
            color: #ff4444;
            border: 2px solid #ff4444;
            font-size: 14px;
            padding: 12px;
            margin-bottom: 3px;
            font-weight: 700;
        }

        .btn-buy-no:hover {
            background: #440000;
        }

        .btn-sell {
            background: #1a1a1a;
            color: #ffffff;
            border: 1px solid #ffffff;
            font-size: 12px;
            padding: 10px;
            margin-bottom: 3px;
        }

        .btn-sell:hover {
            background: #2a2a2a;
        }

        .btn-sizing {
            background: #0a0a0a;
            color: #ffffff;
            font-size: 10px;
            font-weight: 600;
            padding: 6px;
            border: 1px solid #333;
            border-radius: 0;
            cursor: pointer;
            transition: all 0.08s;
        }

        .btn-sizing:hover {
            background: #1a1a1a;
            border-color: #ffffff;
        }

        .btn-sizing:active {
            transform: scale(0.98);
        }

        .ticker-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #000;
            border: 1px solid #ffffff;
            border-radius: 0;
            margin-top: 2px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: none;
        }

        .ticker-item {
            padding: 6px 8px;
            cursor: pointer;
            border-bottom: 1px solid #1a1a1a;
            transition: background 0.05s;
        }

        .ticker-item:hover {
            background: #0a0a0a;
            border-left: 2px solid #ffffff;
        }

        .ticker-item:last-child {
            border-bottom: none;
        }

        .ticker-code {
            font-weight: 600;
            color: #ffffff;
            font-size: 11px;
            font-family: 'Roboto Mono', 'Consolas', monospace;
        }

        .ticker-title {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
        }

        .trading-section {
            display: none;
        }

        .trading-section.active {
            display: block;
        }

        .price-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            background: #000;
            padding: 0;
            border: 1px solid #333;
            border-radius: 0;
            margin-bottom: 5px;
            gap: 0;
        }

        .price-box {
            text-align: center;
            padding: 12px 8px;
            border-right: 1px solid #333;
        }

        .price-box:last-child {
            border-right: none;
        }

        .price-label {
            font-size: 9px;
            color: #666;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .price-value {
            font-size: 28px;
            font-weight: 700;
            font-family: 'Roboto Mono', 'Consolas', monospace;
            letter-spacing: -1px;
        }

        .yes-price { color: #00ff00; }
        .no-price { color: #ff4444; }

        .depth-info {
            font-size: 9px;
            color: #666;
            margin-top: 3px;
        }

        .trade-buttons {
            margin-bottom: 5px;
        }

        .execution-stats {
            background: #0a0a0a;
            padding: 8px;
            border: 1px solid #333;
            border-radius: 0;
            margin-bottom: 5px;
            font-size: 11px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            padding: 3px 0;
            border-bottom: 1px solid #1a1a1a;
        }

        .stat-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .stat-row span:first-child {
            color: #666;
        }

        .stat-row span:last-child {
            color: #ffffff;
            font-family: 'Roboto Mono', 'Consolas', monospace;
            font-weight: 600;
        }

        .alert {
            padding: 6px 8px;
            border-radius: 0;
            margin-bottom: 5px;
            font-size: 10px;
            border-left: 3px solid;
            font-family: 'Roboto Mono', 'Consolas', monospace;
        }

        .alert-warning {
            background: #1a1a00;
            border-color: #ffaa00;
            color: #ffaa00;
        }

        .alert-success {
            background: #0a1a0a;
            border-color: #00ff00;
            color: #00ff00;
        }

        .alert-error {
            background: #1a0000;
            border-color: #ff4444;
            color: #ff4444;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 10px;
            color: #888;
        }

        .price-chart-container {
            background: #0a0a0a;
            padding: 8px;
            border: 1px solid #333;
            border-radius: 0;
            margin-bottom: 5px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid #1a1a1a;
        }

        .chart-title {
            font-size: 11px;
            color: #ffffff;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Slider styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            background: #333;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: #ffffff;
            border: 1px solid #ffffff;
            border-radius: 0;
            cursor: pointer;
            box-shadow: none;
        }

        input[type="range"]::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: #ffffff;
            border: 1px solid #ffffff;
            border-radius: 0;
            cursor: pointer;
            box-shadow: none;
        }

        input[type="range"]:active::-webkit-slider-thumb {
            background: #cccccc;
        }

        input[type="range"]:active::-moz-range-thumb {
            background: #cccccc;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            background-color: #0a0a0a;
            margin: 10% auto;
            padding: 0;
            border: 2px solid #ffffff;
            width: 90%;
            max-width: 600px;
            font-family: 'Roboto Mono', 'Consolas', monospace;
        }

        .modal-header {
            padding: 10px 12px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 12px;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0;
        }

        .modal-close {
            color: #888;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .modal-close:hover {
            color: #ffffff;
        }

        .modal-body {
            padding: 12px;
        }

        .position-item {
            padding: 8px;
            border: 1px solid #333;
            margin-bottom: 5px;
            background: #000;
        }

        .position-item:hover {
            background: #0a0a0a;
            border-color: #ffffff;
        }

        .order-item {
            padding: 6px 8px;
            border: 1px solid #333;
            margin-bottom: 3px;
            background: #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
        }

        .order-item:hover {
            background: #0a0a0a;
        }

        .btn-cancel-order {
            background: #1a0000;
            color: #ff4444;
            border: 1px solid #ff4444;
            padding: 4px 8px;
            font-size: 9px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-cancel-order:hover {
            background: #2a0000;
        }

        /* Keyboard confirmation modal */
        .kbd-modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: #0a0a0a;
            border: 2px solid #ffffff;
            padding: 20px;
            min-width: 400px;
            font-family: 'Roboto Mono', 'Consolas', monospace;
        }

        .kbd-modal-title {
            font-size: 12px;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 700;
        }

        .kbd-modal-body {
            font-size: 11px;
            color: #888;
            margin-bottom: 20px;
            text-align: center;
        }

        .kbd-modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .kbd-btn {
            padding: 12px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            border: 2px solid #333;
            background: #0a0a0a;
            color: #888;
            transition: all 0.1s;
            font-family: 'Roboto Mono', 'Consolas', monospace;
        }

        .kbd-btn.selected {
            border-color: #ffffff;
            background: #1a1a1a;
            color: #ffffff;
        }

        .kbd-btn:hover {
            border-color: #ffffff;
        }

        .kbd-overlay {
            display: none;
            position: fixed;
            z-index: 2999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>[ MLB KALSHI TERMINAL v1.0 ]</h1>
            <div style="font-size: 10px; color: #666;">HIGH-FREQUENCY ARBITRAGE TRADER</div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-label">Auth</div>
                <div class="status-value" id="auth-status">—</div>
            </div>
            <div class="status-item">
                <div class="status-label">Balance</div>
                <div class="status-value" id="balance">—</div>
            </div>
            <div class="status-item">
                <div class="status-label">Latency</div>
                <div class="status-value" id="latency">—</div>
            </div>
        </div>

        <!-- Active Market Display -->
        <div id="active-market-banner" style="display: none; background: #0a0a0a; padding: 6px 8px; border: 1px solid #ffffff; border-radius: 0; margin-bottom: 5px;">
            <div style="font-size: 9px; color: #666; text-transform: uppercase; margin-bottom: 2px; letter-spacing: 0.5px;">ACTIVE MARKET</div>
            <div style="font-size: 13px; font-weight: 700; color: #ffffff; margin-bottom: 2px; font-family: 'Roboto Mono', 'Consolas', monospace;" id="active-ticker">—</div>
            <div style="font-size: 10px; color: #888;" id="active-market-title">—</div>
        </div>

        <!-- Setup Section -->
        <div class="setup-section" id="setup-section">
            <h3>[ SETUP ]</h3>
            <button class="btn-primary" onclick="authenticate()">1. Authenticate to Kalshi</button>

            <div style="margin-top: 5px; position: relative;">
                <input
                    type="text"
                    id="ticker-input"
                    placeholder="SEARCH TICKER (e.g., KXMLB)"
                    autocomplete="off"
                    oninput="searchTickers()"
                    style="width: 100%; padding-right: 40px;">
                <div id="ticker-results" class="ticker-dropdown" style="display: none;"></div>
            </div>

            <button class="btn-primary" onclick="setTicker()">2. Set Market Ticker</button>
        </div>

        <!-- Alerts -->
        <div id="alert-container"></div>

        <!-- Trading Section -->
        <div class="trading-section" id="trading-section">
            <div class="two-column-layout">
                <!-- LEFT COLUMN: Trading Controls -->
                <div class="left-column">
                    <!-- Price Display -->
                    <div class="price-display">
                        <div class="price-box">
                            <div class="price-label">YES</div>
                            <div class="price-value yes-price" id="yes-price">—</div>
                        </div>
                        <div class="price-box">
                            <div class="price-label">NO</div>
                            <div class="price-value no-price" id="no-price">—</div>
                        </div>
                    </div>

                    <!-- Contract Size Input -->
                    <div style="margin-bottom: 5px;">
                        <label style="display: block; margin-bottom: 3px; font-size: 9px; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">CONTRACT SIZE</label>
                        <input type="number" id="contract-size" value="100" min="1" max="100000" style="width: 100%; padding: 8px; font-size: 16px; font-weight: 700; text-align: center; margin-bottom: 5px;">

                        <!-- Bet Sizing Buttons -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 3px; margin-top: 3px;">
                            <button class="btn-sizing" onclick="setBetSize(0.25)">1/4</button>
                            <button class="btn-sizing" onclick="setBetSize(0.5)">1/2</button>
                            <button class="btn-sizing" onclick="setBetSize(0.75)">3/4</button>
                            <button class="btn-sizing" onclick="setBetSize(0.9)">MAX</button>
                        </div>
                        <div style="font-size: 9px; color: #666; text-align: center; margin-top: 3px;">
                            BALANCE-BASED SIZING
                        </div>

                        <!-- Spread Sizer Bar -->
                        <div style="margin-top: 8px; background: #0a0a0a; padding: 8px; border: 1px solid #333; border-radius: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span style="font-size: 9px; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">SPREAD TARGET</span>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <input
                                        type="number"
                                        id="spread-cents-input"
                                        value="3"
                                        min="1"
                                        max="10"
                                        step="0.5"
                                        style="width: 50px; padding: 4px 6px; font-size: 12px; font-weight: 700; text-align: center; background: #000; border: 1px solid #ffffff; color: #ffffff; border-radius: 0; margin-bottom: 0;"
                                        oninput="updateSpreadFromInput()">
                                    <span style="font-size: 10px; color: #ffffff; font-weight: 700;">¢</span>
                                </div>
                            </div>
                            <input
                                type="range"
                                id="spread-slider"
                                min="1"
                                max="10"
                                step="0.5"
                                value="3"
                                style="width: 100%; margin-bottom: 5px;"
                                oninput="updateSpreadFromSlider()">
                            <div style="font-size: 10px; color: #ffffff; font-weight: 600; text-align: center; margin-bottom: 5px; font-family: 'Roboto Mono', 'Consolas', monospace;" id="spread-value">—</div>
                            <div style="font-size: 9px; color: #666; text-align: center;">
                                MAX CONTRACTS @ TARGET SPREAD
                            </div>
                        </div>
                    </div>

                    <!-- Trade Buttons -->
                    <div class="trade-buttons">
                        <button class="btn-buy-yes" onclick="executeTrade('yes', 'buy')">
                            BUY YES
                        </button>
                        <button class="btn-buy-no" onclick="executeTrade('no', 'buy')">
                            BUY NO
                        </button>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3px; margin-bottom: 3px;">
                            <button class="btn-sell" onclick="openSellModal()">
                                LIMIT SELL
                            </button>
                            <button class="btn-sell" onclick="openQuickSellModal()">
                                QUICK SELL
                            </button>
                        </div>
                    </div>

                    <!-- Open Orders Section -->
                    <div style="margin-bottom: 5px; background: #0a0a0a; padding: 8px; border: 1px solid #333;">
                        <h3 style="font-size: 11px; color: #ffffff; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">[ OPEN ORDERS ]</h3>
                        <div id="open-orders-list">
                            <div style="font-size: 10px; color: #666; text-align: center; padding: 10px;">
                                NO OPEN ORDERS
                            </div>
                        </div>
                    </div>

                    <button class="btn-danger" onclick="resetSession()">Reset Session</button>
                </div>

                <!-- RIGHT COLUMN: Stats & Chart -->
                <div class="right-column">
                    <!-- Execution Stats -->
                    <div class="execution-stats">
                        <h3 style="margin-bottom: 6px; font-size: 11px; color: #ffffff; text-transform: uppercase; letter-spacing: 0.5px;">[ SESSION STATS ]</h3>
                        <div class="stat-row">
                            <span>TRADES</span>
                            <span id="total-trades">0</span>
                        </div>
                        <div class="stat-row">
                            <span>AVG LAT</span>
                            <span id="avg-latency">—</span>
                        </div>
                        <div class="stat-row">
                            <span>FASTEST</span>
                            <span id="fastest">—</span>
                        </div>
                        <div class="stat-row">
                            <span>SLOWEST</span>
                            <span id="slowest">—</span>
                        </div>
                    </div>

                    <!-- Orderbook Display -->
                    <div class="price-chart-container">
                        <div class="chart-header">
                            <div class="chart-title">[ LIVE ORDERBOOK ]</div>
                            <div style="font-size: 9px; color: #666;">REAL-TIME DEPTH</div>
                        </div>

                        <!-- YES Orderbook -->
                        <div style="margin-bottom: 10px;">
                            <div style="font-size: 10px; color: #00ff00; font-weight: 700; margin-bottom: 4px; padding: 4px 6px; background: #0a1a0a; border-left: 2px solid #00ff00; text-transform: uppercase; letter-spacing: 0.5px;">
                                YES MARKET
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; font-size: 9px; color: #666; padding: 3px 6px; border-bottom: 1px solid #1a1a1a; text-transform: uppercase; letter-spacing: 0.3px;">
                                <div>PRICE</div>
                                <div style="text-align: right;">QTY</div>
                                <div style="text-align: right;">TOTAL</div>
                            </div>
                            <div id="yes-orderbook" style="max-height: 180px; overflow-y: auto;">
                                <div style="padding: 15px; text-align: center; color: #666; font-size: 10px;">
                                    LOADING...
                                </div>
                            </div>
                        </div>

                        <!-- NO Orderbook -->
                        <div>
                            <div style="font-size: 10px; color: #ff4444; font-weight: 700; margin-bottom: 4px; padding: 4px 6px; background: #1a0000; border-left: 2px solid #ff4444; text-transform: uppercase; letter-spacing: 0.5px;">
                                NO MARKET
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; font-size: 9px; color: #666; padding: 3px 6px; border-bottom: 1px solid #1a1a1a; text-transform: uppercase; letter-spacing: 0.3px;">
                                <div>PRICE</div>
                                <div style="text-align: right;">QTY</div>
                                <div style="text-align: right;">TOTAL</div>
                            </div>
                            <div id="no-orderbook" style="max-height: 180px; overflow-y: auto;">
                                <div style="padding: 15px; text-align: center; color: #666; font-size: 10px;">
                                    LOADING...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trade Log Section (Full Width) -->
            <div class="trading-section active" style="margin-top: 5px;">
                <div class="setup-section">
                    <h3 style="display: flex; justify-content: space-between; align-items: center;">
                        <span>[ TRADE LOG ]</span>
                        <span id="log-summary" style="font-size: 9px; color: #666; font-weight: 600;">—</span>
                    </h3>

                    <!-- Trade Log Table -->
                    <div style="overflow-x: auto; max-height: 400px; overflow-y: auto; margin-top: 6px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 10px; font-family: 'Roboto Mono', 'Consolas', monospace;">
                            <thead style="position: sticky; top: 0; background: #0a0a0a; z-index: 10;">
                                <tr style="border-bottom: 1px solid #333;">
                                    <th style="padding: 5px 6px; text-align: left; color: #666; font-size: 9px; text-transform: uppercase; letter-spacing: 0.3px;">TIME</th>
                                    <th style="padding: 5px 6px; text-align: left; color: #666; font-size: 9px; text-transform: uppercase; letter-spacing: 0.3px;">TICKER</th>
                                    <th style="padding: 5px 6px; text-align: left; color: #666; font-size: 9px; text-transform: uppercase; letter-spacing: 0.3px;">ACTION</th>
                                    <th style="padding: 5px 6px; text-align: right; color: #666; font-size: 9px; text-transform: uppercase; letter-spacing: 0.3px;">QTY</th>
                                    <th style="padding: 5px 6px; text-align: right; color: #666; font-size: 9px; text-transform: uppercase; letter-spacing: 0.3px;">EXEC</th>
                                    <th style="padding: 5px 6px; text-align: right; color: #666; font-size: 9px; text-transform: uppercase; letter-spacing: 0.3px;">MKT</th>
                                    <th style="padding: 5px 6px; text-align: right; color: #666; font-size: 9px; text-transform: uppercase; letter-spacing: 0.3px;">SLIP</th>
                                    <th style="padding: 5px 6px; text-align: right; color: #666; font-size: 9px; text-transform: uppercase; letter-spacing: 0.3px;">LAT</th>
                                    <th style="padding: 5px 6px; text-align: right; color: #666; font-size: 9px; text-transform: uppercase; letter-spacing: 0.3px;">COST</th>
                                </tr>
                            </thead>
                            <tbody id="trade-log-body" style="font-family: 'Roboto Mono', 'Consolas', monospace;">
                                <tr>
                                    <td colspan="9" style="padding: 20px; text-align: center; color: #666; font-size: 10px;">
                                        NO TRADES YET
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sell Modal -->
    <div id="sellModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>[ SELL POSITION - LIMIT ORDER ]</h2>
                <span class="modal-close" onclick="closeSellModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="positions-list">
                    <div style="font-size: 10px; color: #666; text-align: center; padding: 20px;">
                        LOADING POSITIONS...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Sell Modal -->
    <div id="quickSellModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>[ QUICK SELL - MARKET ORDER ]</h2>
                <span class="modal-close" onclick="closeQuickSellModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="quicksell-positions-list">
                    <div style="font-size: 10px; color: #666; text-align: center; padding: 20px;">
                        LOADING POSITIONS...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Keyboard Confirmation Modal -->
    <div id="kbdOverlay" class="kbd-overlay"></div>
    <div id="kbdModal" class="kbd-modal">
        <div class="kbd-modal-title" id="kbdTitle">CONFIRM ACTION</div>
        <div class="kbd-modal-body" id="kbdBody">
            Action details
        </div>
        <div class="kbd-modal-buttons">
            <button class="kbd-btn selected" id="kbdYes" onclick="kbdConfirm()">✓ YES</button>
            <button class="kbd-btn" id="kbdNo" onclick="kbdCancel()">✗ NO</button>
        </div>
    </div>

    <script>
        let priceUpdateInterval = null;
        let currentBalance = 0; // Track current balance
        let lastYesPrice = 0;
        let lastNoPrice = 0;

        // Keyboard confirmation state
        let kbdAction = null;
        let kbdSelectedButton = 0; // 0 = YES, 1 = NO

        // Update spread from slider
        function updateSpreadFromSlider() {
            const slider = document.getElementById('spread-slider');
            const input = document.getElementById('spread-cents-input');
            const value = parseFloat(slider.value);

            input.value = value;
            updateSliderGradient(value);
            setSpreadSize(value);
        }

        // Update spread from input box
        function updateSpreadFromInput() {
            const input = document.getElementById('spread-cents-input');
            const slider = document.getElementById('spread-slider');
            let value = parseFloat(input.value);

            // Clamp value between min and max
            if (value < 1) value = 1;
            if (value > 10) value = 10;

            input.value = value;
            slider.value = value;
            updateSliderGradient(value);
            setSpreadSize(value);
        }

        // Update slider gradient to show progress
        function updateSliderGradient(value) {
            const slider = document.getElementById('spread-slider');
            const percentage = ((value - 1) / (10 - 1)) * 100;
            slider.style.background = `linear-gradient(to right, #ffffff 0%, #ffffff ${percentage}%, #333 ${percentage}%, #333 100%)`;
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Don't trigger if typing in input field
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return;
            }

            // Handle keyboard confirmation navigation
            const kbdModal = document.getElementById('kbdModal');
            if (kbdModal.style.display === 'block') {
                if (event.key === 'ArrowLeft' || event.key === 'ArrowRight') {
                    event.preventDefault();
                    kbdToggleSelection();
                } else if (event.key === 'Enter') {
                    event.preventDefault();
                    kbdConfirm();
                } else if (event.key === 'Escape') {
                    event.preventDefault();
                    kbdCancel();
                }
                return;
            }

            // Main keyboard shortcuts
            const key = event.key.toLowerCase();

            if (key === 'y') {
                event.preventDefault();
                showKbdConfirmation('BUY YES', () => executeTrade('yes', 'buy'));
            } else if (key === 'n') {
                event.preventDefault();
                showKbdConfirmation('BUY NO', () => executeTrade('no', 'buy'));
            } else if (key === 'q') {
                event.preventDefault();
                showKbdConfirmation('QUICK SELL', () => openQuickSellModal());
            } else if (key === 's') {
                event.preventDefault();
                showKbdConfirmation('LIMIT SELL', () => openSellModal());
            }
        });

        function showKbdConfirmation(actionName, actionCallback) {
            const contractSize = document.getElementById('contract-size').value;

            let bodyText = '';
            if (actionName === 'BUY YES') {
                const price = document.getElementById('yes-price').textContent;
                bodyText = `Buy ${contractSize} YES contracts @ ${price}¢`;
            } else if (actionName === 'BUY NO') {
                const price = document.getElementById('no-price').textContent;
                bodyText = `Buy ${contractSize} NO contracts @ ${price}¢`;
            } else if (actionName === 'QUICK SELL') {
                bodyText = 'Open Quick Sell modal (market orders)';
            } else if (actionName === 'LIMIT SELL') {
                bodyText = 'Open Limit Sell modal (limit orders)';
            }

            document.getElementById('kbdTitle').textContent = actionName;
            document.getElementById('kbdBody').textContent = bodyText;

            kbdAction = actionCallback;
            kbdSelectedButton = 0; // Default to YES
            updateKbdButtonSelection();

            document.getElementById('kbdModal').style.display = 'block';
            document.getElementById('kbdOverlay').style.display = 'block';
        }

        function kbdToggleSelection() {
            kbdSelectedButton = kbdSelectedButton === 0 ? 1 : 0;
            updateKbdButtonSelection();
        }

        function updateKbdButtonSelection() {
            const yesBtn = document.getElementById('kbdYes');
            const noBtn = document.getElementById('kbdNo');

            if (kbdSelectedButton === 0) {
                yesBtn.classList.add('selected');
                noBtn.classList.remove('selected');
            } else {
                yesBtn.classList.remove('selected');
                noBtn.classList.add('selected');
            }
        }

        function kbdConfirm() {
            if (kbdSelectedButton === 0 && kbdAction) {
                kbdAction();
            }
            kbdCancel();
        }

        function kbdCancel() {
            document.getElementById('kbdModal').style.display = 'none';
            document.getElementById('kbdOverlay').style.display = 'none';
            kbdAction = null;
            kbdSelectedButton = 0;
        }

        // Modal functions
        async function openSellModal() {
            const modal = document.getElementById('sellModal');
            modal.style.display = 'block';
            await loadPositions();
        }

        function closeSellModal() {
            const modal = document.getElementById('sellModal');
            modal.style.display = 'none';
        }

        async function openQuickSellModal() {
            const modal = document.getElementById('quickSellModal');
            modal.style.display = 'block';
            await loadQuickSellPositions();
        }

        function closeQuickSellModal() {
            const modal = document.getElementById('quickSellModal');
            modal.style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const sellModal = document.getElementById('sellModal');
            const quickSellModal = document.getElementById('quickSellModal');
            if (event.target == sellModal) {
                sellModal.style.display = 'none';
            }
            if (event.target == quickSellModal) {
                quickSellModal.style.display = 'none';
            }
        }

        // Load positions for selling
        async function loadPositions() {
            try {
                const response = await fetch('/api/positions');
                const data = await response.json();

                const positionsList = document.getElementById('positions-list');

                if (!data.success || !data.positions || data.positions.length === 0) {
                    positionsList.innerHTML = '<div style="font-size: 10px; color: #666; text-align: center; padding: 20px;">NO POSITIONS FOUND</div>';
                    return;
                }

                positionsList.innerHTML = data.positions.map(pos => {
                    const sideColor = pos.side === 'yes' ? '#00ff00' : '#ff4444';
                    return `
                        <div class="position-item">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <div style="font-size: 11px; font-weight: 700; color: ${sideColor};">
                                    ${pos.side.toUpperCase()} - ${pos.quantity} contracts
                                </div>
                                <div style="font-size: 10px; color: #888;">
                                    Entry: ${pos.entry_price}¢
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 6px;">
                                <input type="number" id="sell-price-${pos.side}" placeholder="Limit Price (¢)"
                                    style="padding: 6px; font-size: 11px;" min="1" max="99">
                                <input type="number" id="sell-qty-${pos.side}" placeholder="Quantity"
                                    style="padding: 6px; font-size: 11px;" min="1" max="${pos.quantity}" value="${pos.quantity}">
                            </div>
                            <button class="btn-sell" style="margin-top: 6px; width: 100%;"
                                onclick="placeSellOrder('${pos.side}')">
                                PLACE LIMIT SELL ORDER
                            </button>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load positions:', error);
                showAlert('Failed to load positions: ' + error.message, 'error');
            }
        }

        // Place sell limit order
        async function placeSellOrder(side) {
            const priceInput = document.getElementById(`sell-price-${side}`);
            const qtyInput = document.getElementById(`sell-qty-${side}`);

            const price = parseInt(priceInput.value);
            const quantity = parseInt(qtyInput.value);

            if (!price || price < 1 || price > 99) {
                showAlert('Please enter a valid limit price (1-99¢)', 'error');
                return;
            }

            if (!quantity || quantity < 1) {
                showAlert('Please enter a valid quantity', 'error');
                return;
            }

            try {
                const response = await fetch('/api/sell-limit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        side: side,
                        price: price,
                        count: quantity
                    })
                });
                const data = await response.json();

                if (data.success) {
                    showAlert(`Limit order placed: SELL ${side.toUpperCase()} @ ${price}¢`, 'success');
                    closeSellModal();
                    updateOpenOrders();
                    updateBalance();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showAlert('Failed to place order: ' + error.message, 'error');
            }
        }

        // Update open orders list
        async function updateOpenOrders() {
            try {
                const response = await fetch('/api/orders');
                const data = await response.json();

                const ordersList = document.getElementById('open-orders-list');

                if (!data.success || !data.orders || data.orders.length === 0) {
                    ordersList.innerHTML = '<div style="font-size: 10px; color: #666; text-align: center; padding: 10px;">NO OPEN ORDERS</div>';
                    return;
                }

                ordersList.innerHTML = data.orders.map(order => {
                    const sideColor = order.side === 'yes' ? '#00ff00' : '#ff4444';
                    return `
                        <div class="order-item">
                            <div>
                                <span style="color: ${sideColor}; font-weight: 700;">${order.action.toUpperCase()} ${order.side.toUpperCase()}</span>
                                <span style="color: #888;"> - ${order.remaining_count}/${order.count} @ ${order.yes_price || order.no_price}¢</span>
                            </div>
                            <button class="btn-cancel-order" onclick="cancelOrder('${order.order_id}')">
                                CANCEL
                            </button>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load orders:', error);
            }
        }

        // Cancel an order
        async function cancelOrder(orderId) {
            if (!confirm('Cancel this order?')) return;

            try {
                const response = await fetch('/api/cancel-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_id: orderId })
                });
                const data = await response.json();

                if (data.success) {
                    showAlert('Order cancelled', 'success');
                    updateOpenOrders();
                    updateBalance();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showAlert('Failed to cancel order: ' + error.message, 'error');
            }
        }

        // Load positions for quick sell (market orders)
        async function loadQuickSellPositions() {
            try {
                const response = await fetch('/api/positions');
                const data = await response.json();

                const positionsList = document.getElementById('quicksell-positions-list');

                if (!data.success || !data.positions || data.positions.length === 0) {
                    positionsList.innerHTML = '<div style="font-size: 10px; color: #666; text-align: center; padding: 20px;">NO POSITIONS FOUND</div>';
                    return;
                }

                positionsList.innerHTML = data.positions.map(pos => {
                    const sideColor = pos.side === 'yes' ? '#00ff00' : '#ff4444';
                    return `
                        <div class="position-item">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <div style="font-size: 11px; font-weight: 700; color: ${sideColor};">
                                    ${pos.side.toUpperCase()} - ${pos.quantity} contracts
                                </div>
                                <div style="font-size: 10px; color: #888;">
                                    Entry: ${pos.entry_price}¢
                                </div>
                            </div>
                            <div style="margin-top: 6px;">
                                <input type="number" id="quicksell-qty-${pos.side}" placeholder="Quantity"
                                    style="padding: 6px; font-size: 11px; width: 100%; margin-bottom: 6px;"
                                    min="1" max="${pos.quantity}" value="${pos.quantity}">
                            </div>
                            <button class="btn-sell" style="margin-top: 6px; width: 100%; background: #ffaa00; border-color: #ffaa00; color: #000;"
                                onclick="executeQuickSell('${pos.side}')">
                                QUICK SELL (MARKET ORDER)
                            </button>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load positions:', error);
                showAlert('Failed to load positions: ' + error.message, 'error');
            }
        }

        // Execute quick sell (market order)
        async function executeQuickSell(side) {
            const qtyInput = document.getElementById(`quicksell-qty-${side}`);
            const quantity = parseInt(qtyInput.value);

            if (!quantity || quantity < 1) {
                showAlert('Please enter a valid quantity', 'error');
                return;
            }

            if (!confirm(`Quick sell ${quantity} ${side.toUpperCase()} contracts at market price?`)) {
                return;
            }

            try {
                const start = Date.now();
                const response = await fetch('/api/trade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        side: side,
                        action: 'sell',
                        count: quantity
                    })
                });
                const data = await response.json();
                const totalTime = Date.now() - start;

                if (data.success) {
                    const order = data.order;
                    const price = order.yes_price || order.no_price || 'N/A';
                    const msg = `QUICK SELL ${side.toUpperCase()} - ${quantity} contracts @ ${price}¢ in ${totalTime}ms`;
                    showAlert(msg, totalTime < 500 ? 'success' : 'warning');
                    closeQuickSellModal();
                    updateOpenOrders();
                    updateBalance();
                    updateStats();
                    updateTradeLog();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showAlert('Quick sell failed: ' + error.message, 'error');
            }
        }

        // Spread sizing function
        function setSpreadSize(targetSpread) {
            const yesPriceText = document.getElementById('yes-price').textContent;
            const noPriceText = document.getElementById('no-price').textContent;

            if (yesPriceText === '—' || noPriceText === '—') {
                showAlert('Wait for prices to load', 'warning');
                return;
            }

            const yesPrice = parseFloat(yesPriceText);
            const noPrice = parseFloat(noPriceText);

            if (currentBalance <= 0) {
                showAlert('Balance not available', 'warning');
                return;
            }

            // Calculate contracts needed for target spread profit
            // If spread is 3¢, and you want $X profit, you need X/0.03 contracts
            // But we want to calculate max contracts you can buy with current balance
            const price = Math.max(yesPrice, noPrice);
            const dollarPrice = price / 100;
            const targetSpreadDollars = targetSpread / 100;

            // Calculate how many contracts you can buy with your balance
            const maxContracts = Math.floor(currentBalance / dollarPrice);

            // The potential profit would be: maxContracts * targetSpreadDollars
            const potentialProfit = maxContracts * targetSpreadDollars;

            document.getElementById('contract-size').value = maxContracts;
            document.getElementById('spread-value').textContent =
                `${maxContracts.toLocaleString()} contracts = $${potentialProfit.toFixed(2)} profit @ ${targetSpread}¢ spread`;
        }

        // Bet sizing function
        function setBetSize(fraction) {
            // Get current prices - use the HIGHER price to be extra conservative
            const yesPriceText = document.getElementById('yes-price').textContent;
            const noPriceText = document.getElementById('no-price').textContent;

            if (yesPriceText === '—' || noPriceText === '—') {
                showAlert('Wait for prices to load', 'warning');
                return;
            }

            const yesPrice = parseFloat(yesPriceText);
            const noPrice = parseFloat(noPriceText);

            // Use the HIGHER price for conservative calculation (worst case scenario)
            // This ensures you can afford the trade no matter which side you click
            const price = Math.max(yesPrice, noPrice);

            if (currentBalance <= 0 || price <= 0) {
                showAlert('Balance or price not available', 'warning');
                return;
            }

            // Calculate max contracts with extra safety margin
            // Use higher price + reduce effective balance to prevent insufficient funds
            const dollarPrice = price / 100;
            const safetyMargin = 0.98; // Use 98% of calculated amount for safety
            const maxContracts = Math.floor((currentBalance * fraction * safetyMargin) / dollarPrice);

            if (maxContracts < 1) {
                showAlert('Insufficient balance for this size', 'warning');
                return;
            }

            document.getElementById('contract-size').value = maxContracts;
        }

        // Update orderbook display
        async function updateOrderbook() {
            try {
                const response = await fetch('/api/orderbook-depth');
                const data = await response.json();

                if (data.success && data.orderbook) {
                    // Update YES orderbook - filter to 5¢ spread
                    const yesOrderbook = document.getElementById('yes-orderbook');
                    if (data.orderbook.yes && data.orderbook.yes.length > 0) {
                        // Get best (highest) YES price
                        const bestYesPrice = data.orderbook.yes[0].price;
                        // Filter to only show within 5¢ of best price
                        const filteredYes = data.orderbook.yes.filter(level => level.price >= bestYesPrice - 5);

                        if (filteredYes.length > 0) {
                            let runningTotal = 0;
                            yesOrderbook.innerHTML = filteredYes.map(level => {
                                runningTotal += level.quantity;
                                return `
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; padding: 4px 6px; border-bottom: 1px solid #1a1a1a; font-size: 10px; font-family: 'Roboto Mono', 'Consolas', monospace;">
                                        <div style="color: #00ff00; font-weight: 700;">${level.price}¢</div>
                                        <div style="text-align: right; color: #00ff00;">${level.quantity.toLocaleString()}</div>
                                        <div style="text-align: right; color: #666;">${runningTotal.toLocaleString()}</div>
                                    </div>
                                `;
                            }).join('');
                        } else {
                            yesOrderbook.innerHTML = '<div style="padding: 15px; text-align: center; color: #666; font-size: 10px;">NO ORDERS</div>';
                        }
                    } else {
                        yesOrderbook.innerHTML = '<div style="padding: 15px; text-align: center; color: #666; font-size: 10px;">NO ORDERS</div>';
                    }

                    // Update NO orderbook - filter to 5¢ spread
                    const noOrderbook = document.getElementById('no-orderbook');
                    if (data.orderbook.no && data.orderbook.no.length > 0) {
                        // Get best (highest) NO price
                        const bestNoPrice = data.orderbook.no[0].price;
                        // Filter to only show within 5¢ of best price
                        const filteredNo = data.orderbook.no.filter(level => level.price >= bestNoPrice - 5);

                        if (filteredNo.length > 0) {
                            let runningTotal = 0;
                            noOrderbook.innerHTML = filteredNo.map(level => {
                                runningTotal += level.quantity;
                                return `
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; padding: 4px 6px; border-bottom: 1px solid #1a1a1a; font-size: 10px; font-family: 'Roboto Mono', 'Consolas', monospace;">
                                        <div style="color: #ff4444; font-weight: 700;">${level.price}¢</div>
                                        <div style="text-align: right; color: #ff4444;">${level.quantity.toLocaleString()}</div>
                                        <div style="text-align: right; color: #666;">${runningTotal.toLocaleString()}</div>
                                    </div>
                                `;
                            }).join('');
                        } else {
                            noOrderbook.innerHTML = '<div style="padding: 15px; text-align: center; color: #666; font-size: 10px;">NO ORDERS</div>';
                        }
                    } else {
                        noOrderbook.innerHTML = '<div style="padding: 15px; text-align: center; color: #666; font-size: 10px;">NO ORDERS</div>';
                    }
                }
            } catch (error) {
                console.error('Orderbook update failed:', error);
            }
        }

        function showAlert(message, type = 'success') {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Ticker search with debouncing
        let searchTimeout = null;
        async function searchTickers() {
            const query = document.getElementById('ticker-input').value.trim();

            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            if (query.length < 2) {
                document.getElementById('ticker-results').style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/search-markets?q=${encodeURIComponent(query)}&limit=50`);
                    const data = await response.json();

                    if (data.success && data.markets.length > 0) {
                        displayTickerResults(data.markets);
                    } else {
                        document.getElementById('ticker-results').style.display = 'none';
                    }
                } catch (error) {
                    console.error('Ticker search failed:', error);
                }
            }, 300); // Debounce 300ms
        }

        function displayTickerResults(markets) {
            const resultsDiv = document.getElementById('ticker-results');
            resultsDiv.innerHTML = '';

            markets.forEach(market => {
                const item = document.createElement('div');
                item.className = 'ticker-item';
                item.onclick = () => selectTicker(market.ticker);

                const code = document.createElement('div');
                code.className = 'ticker-code';
                code.textContent = market.ticker;

                const title = document.createElement('div');
                title.className = 'ticker-title';
                title.textContent = market.title;

                item.appendChild(code);
                item.appendChild(title);
                resultsDiv.appendChild(item);
            });

            resultsDiv.style.display = 'block';
        }

        function selectTicker(ticker) {
            document.getElementById('ticker-input').value = ticker;
            document.getElementById('ticker-results').style.display = 'none';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#ticker-input') && !e.target.closest('#ticker-results')) {
                document.getElementById('ticker-results').style.display = 'none';
            }
        });

        async function authenticate() {
            try {
                const response = await fetch('/api/auth', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('auth-status').textContent = '✓';
                    document.getElementById('auth-status').className = 'status-value status-good';
                    showAlert('Authenticated successfully', 'success');
                    updateBalance();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showAlert('Authentication failed: ' + error.message, 'error');
                document.getElementById('auth-status').textContent = '✗';
                document.getElementById('auth-status').className = 'status-value status-bad';
            }
        }

        async function updateBalance() {
            try {
                const response = await fetch('/api/balance');
                const data = await response.json();

                if (data.success) {
                    currentBalance = data.balance; // Store for bet sizing
                    document.getElementById('balance').textContent = '$' + data.balance.toFixed(2);
                }
            } catch (error) {
                console.error('Balance update failed:', error);
            }
        }

        async function setTicker() {
            const ticker = document.getElementById('ticker-input').value.trim();
            if (!ticker) {
                showAlert('Please enter a ticker', 'error');
                return;
            }

            try {
                const response = await fetch('/api/ticker', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticker })
                });
                const data = await response.json();

                if (data.success) {
                    showAlert('Market loaded: ' + ticker, 'success');

                    // Update active market banner
                    document.getElementById('active-ticker').textContent = ticker;
                    document.getElementById('active-market-title').textContent = data.market.title || 'Market loaded';
                    document.getElementById('active-market-banner').style.display = 'block';

                    document.getElementById('setup-section').style.display = 'none';
                    document.getElementById('trading-section').classList.add('active');

                    // Start price updates - every 200ms (0.2s) for fastest response
                    updatePrices();
                    priceUpdateInterval = setInterval(updatePrices, 200);

                    // Update orderbook every 500ms
                    updateOrderbook();
                    setInterval(updateOrderbook, 500);

                    // Update open orders every 2 seconds
                    updateOpenOrders();
                    setInterval(updateOpenOrders, 2000);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showAlert('Failed to load market: ' + error.message, 'error');
            }
        }

        async function updatePrices() {
            try {
                const start = Date.now();
                const response = await fetch('/api/orderbook');
                const data = await response.json();

                if (data.success) {
                    // Display prices in cents
                    const yesPrice = data.yes_price !== null && data.yes_price !== undefined ? data.yes_price : null;
                    const noPrice = data.no_price !== null && data.no_price !== undefined ? data.no_price : null;

                    const yesPriceDisplay = yesPrice !== null ? yesPrice : '—';
                    const noPriceDisplay = noPrice !== null ? noPrice : '—';

                    document.getElementById('yes-price').textContent = yesPriceDisplay;
                    document.getElementById('no-price').textContent = noPriceDisplay;

                    // Store prices for spread calculation
                    if (yesPrice !== null) lastYesPrice = yesPrice;
                    if (noPrice !== null) lastNoPrice = noPrice;

                    const latency = Date.now() - start;
                    const latencyEl = document.getElementById('latency');
                    latencyEl.textContent = latency + 'ms';
                    latencyEl.className = 'status-value ' +
                        (latency < 300 ? 'status-good' :
                         latency < 500 ? 'status-warning' : 'status-bad');
                } else {
                    console.error('Orderbook error:', data.error);
                }
            } catch (error) {
                console.error('Price update failed:', error);
            }
        }

        async function executeTrade(side, action) {
            const button = event.target;
            button.disabled = true;
            button.textContent = 'EXECUTING...';

            // Get contract size from input
            const contractSize = parseInt(document.getElementById('contract-size').value);

            if (!contractSize || contractSize < 1) {
                showAlert('Invalid contract size', 'error');
                button.disabled = false;
                button.textContent = `${action === 'buy' ? 'BUY' : 'SELL'} ${side.toUpperCase()}`;
                return;
            }

            try {
                const start = Date.now();

                // Get current price from UI for buys (old price before market updates)
                let currentPrice = null;
                if (action === 'buy') {
                    const priceText = document.getElementById(`${side}-price`).textContent;
                    const priceNum = parseFloat(priceText);

                    if (isNaN(priceNum) || priceText === '—') {
                        showAlert('Cannot read current price - wait for prices to load', 'error');
                        button.disabled = false;
                        button.textContent = `${action === 'buy' ? 'BUY' : 'SELL'} ${side.toUpperCase()}`;
                        return;
                    }

                    // Convert to cents if it's in dollars (e.g., 0.86 -> 86)
                    currentPrice = priceNum < 1 ? Math.round(priceNum * 100) : Math.round(priceNum);
                }

                const response = await fetch('/api/trade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        side,
                        action,
                        count: contractSize,
                        current_price: currentPrice
                    })
                });
                const data = await response.json();
                const totalTime = Date.now() - start;

                if (data.success) {
                    // Extract execution price from order response
                    const order = data.order;
                    const price = order.yes_price || order.no_price || 'N/A';

                    const msg = `${action.toUpperCase()} ${side.toUpperCase()} - ${contractSize} contracts @ ${price}¢ in ${totalTime}ms`;
                    showAlert(msg, totalTime < 500 ? 'success' : 'warning');

                    if (data.warning) {
                        showAlert(data.warning, 'warning');
                    }

                    // Update balance locally for instant feedback
                    if (action === 'buy' && typeof price === 'number') {
                        // Buying costs money
                        const tradeCost = (contractSize * price) / 100; // Convert cents to dollars
                        currentBalance -= tradeCost;
                        document.getElementById('balance').textContent = '$' + currentBalance.toFixed(2);
                    } else if (action === 'sell' && typeof price === 'number') {
                        // Selling adds money
                        const tradeRevenue = (contractSize * price) / 100; // Convert cents to dollars
                        currentBalance += tradeRevenue;
                        document.getElementById('balance').textContent = '$' + currentBalance.toFixed(2);
                    }

                    updateStats();
                    updateBalance();  // Still fetch from API to get accurate balance
                    updateTradeLog();  // Update trade log
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showAlert('Trade failed: ' + error.message, 'error');
            } finally {
                // Re-enable button
                button.disabled = false;
                button.textContent = `${action === 'buy' ? 'BUY' : 'SELL'} ${side.toUpperCase()}`;
            }
        }

        async function updateStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('total-trades').textContent = data.total_trades;
                    document.getElementById('avg-latency').textContent =
                        data.avg_latency_ms ? data.avg_latency_ms.toFixed(0) + 'ms' : '—';
                    document.getElementById('fastest').textContent =
                        data.fastest_ms ? data.fastest_ms.toFixed(0) + 'ms' : '—';
                    document.getElementById('slowest').textContent =
                        data.slowest_ms ? data.slowest_ms.toFixed(0) + 'ms' : '—';
                }
            } catch (error) {
                console.error('Stats update failed:', error);
            }
        }

        async function updateTradeLog() {
            try {
                const response = await fetch('/api/trade-log');
                const data = await response.json();

                if (data.success) {
                    const logBody = document.getElementById('trade-log-body');
                    const summary = document.getElementById('log-summary');

                    // Update summary
                    if (data.summary.total_trades > 0) {
                        summary.innerHTML = `
                            Trades: ${data.summary.total_trades} |
                            Volume: $${data.summary.total_volume_usd.toFixed(2)} |
                            Avg Slippage: ${data.summary.avg_slippage_cents.toFixed(2)}¢ |
                            Total Slippage: $${data.summary.total_slippage_usd.toFixed(2)}
                        `;
                    }

                    // Update table rows
                    if (data.trades.length === 0) {
                        logBody.innerHTML = `
                            <tr>
                                <td colspan="9" style="padding: 20px; text-align: center; color: #666; font-size: 10px;">
                                    NO TRADES YET
                                </td>
                            </tr>
                        `;
                    } else {
                        // Display trades in reverse order (most recent first)
                        logBody.innerHTML = data.trades.slice().reverse().map(trade => {
                            const time = new Date(trade.timestamp).toLocaleTimeString('en-US', {hour12: false});
                            const actionText = `${trade.action.toUpperCase()} ${trade.side.toUpperCase()}`;
                            const actionColor = trade.action === 'buy'
                                ? (trade.side === 'yes' ? '#00ff00' : '#ff4444')
                                : '#ffffff';

                            const slippageColor = trade.slippage_cents > 0 ? '#ff4444' : '#00ff00';

                            return `
                                <tr style="border-bottom: 1px solid #1a1a1a;">
                                    <td style="padding: 5px 6px; color: #888;">${time}</td>
                                    <td style="padding: 5px 6px; color: #ffffff; font-size: 9px;">${trade.ticker || '—'}</td>
                                    <td style="padding: 5px 6px; color: ${actionColor}; font-weight: 700;">${actionText}</td>
                                    <td style="padding: 5px 6px; text-align: right; color: #888;">${trade.count}</td>
                                    <td style="padding: 5px 6px; text-align: right; color: #ffffff;">${trade.executed_price}¢</td>
                                    <td style="padding: 5px 6px; text-align: right; color: #666;">${trade.pre_market_price}¢</td>
                                    <td style="padding: 5px 6px; text-align: right; color: ${slippageColor}; font-weight: 700;">
                                        ${trade.slippage_cents > 0 ? '+' : ''}${trade.slippage_cents.toFixed(1)}¢
                                        <br><span style="font-size: 9px;">${trade.slippage_cost_usd >= 0 ? '+' : ''}$${trade.slippage_cost_usd.toFixed(2)}</span>
                                    </td>
                                    <td style="padding: 5px 6px; text-align: right; color: ${trade.latency_ms > 500 ? '#ff4444' : '#666'};">
                                        ${trade.latency_ms.toFixed(0)}ms
                                    </td>
                                    <td style="padding: 5px 6px; text-align: right; color: #888;">$${trade.total_cost_usd.toFixed(2)}</td>
                                </tr>
                            `;
                        }).join('');
                    }
                }
            } catch (error) {
                console.error('Trade log update failed:', error);
            }
        }

        async function resetSession() {
            if (!confirm('Reset session stats?')) return;

            try {
                const response = await fetch('/api/reset-session', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    showAlert('Session reset', 'success');
                    updateStats();
                    updateTradeLog();  // Clear trade log

                    // Reset spread value display
                    document.getElementById('spread-value').textContent = '—';
                }
            } catch (error) {
                showAlert('Reset failed: ' + error.message, 'error');
            }
        }

        // Initialize trade log on page load
        window.addEventListener('load', () => {
            updateTradeLog();
            // Initialize slider gradient
            const slider = document.getElementById('spread-slider');
            updateSliderGradient(parseFloat(slider.value));
        });

        // Prevent accidental navigation
        window.addEventListener('beforeunload', (e) => {
            if (document.getElementById('trading-section').classList.contains('active')) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
